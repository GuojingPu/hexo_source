---
title: 项目部署之阿里云服务器环境配置、数据库安装
categories:
  - 技术
  - 阿里云服务器
tags:
  - 阿里云服务器
  - 部署
comments: true
abbrlink: 46899
date: 2018-11-06 21:33:50
img:
---
今天主要讲使用阿里云服务器部署项目，首先介绍一下我的阿里云系统是Ubuntu 16.04 64位的版本。
## 登录阿里云服务器
首先使用ssh登陆阿里云服务器：
![QQ20181106-213721@2x](http://pc59bkg3l.bkt.clouddn.com/QQ20181106-213721@2x.png)

阿里云服务默认是使用的root用户，所以不需要我们再开启root用户了，如果你没有开启root用户，可以使用`sudo passwd root`命令，然后输入2遍root密码开启root。

##修改apt的安装源

对于原版的ubuntu系统apt的安装包的源是国外的，我们可以在

```
/etc/apt/source.list
```
文件中查看apt源,但是更好的是我们可以把apt源替换成国内的源。

为了避免出错你可以首先备份一下source.list

cd 到/etc/apt/目录下执行：

```
cp source.list  source.list.bak
```
会把source.list拷贝一份并命令为source.list.bak。

然后我们可以删除source.list内容，把内容替换成下面的源：

```
deb-src http://archive.ubuntu.com/ubuntu xenial main restricted
deb http://mirrors.aliyun.com/ubuntu/ xenial main restricted
deb-src http://mirrors.aliyun.com/ubuntu/ xenial main restricted multiverse universe
deb http://mirrors.aliyun.com/ubuntu/ xenial-updates main restricted
deb-src http://mirrors.aliyun.com/ubuntu/ xenial-updates main restricted multiverse universe
deb http://mirrors.aliyun.com/ubuntu/ xenial universe
deb http://mirrors.aliyun.com/ubuntu/ xenial-updates universe
deb http://mirrors.aliyun.com/ubuntu/ xenial multiverse
deb http://mirrors.aliyun.com/ubuntu/ xenial-updates multiverse
deb http://mirrors.aliyun.com/ubuntu/ xenial-backports main restricted universe multiverse
deb-src http://mirrors.aliyun.com/ubuntu/ xenial-backports main restricted universe multiverse
deb http://archive.canonical.com/ubuntu xenial partner
deb-src http://archive.canonical.com/ubuntu xenial partner
deb http://mirrors.aliyun.com/ubuntu/ xenial-security main restricted
deb-src http://mirrors.aliyun.com/ubuntu/ xenial-security main restricted multiverse universe
deb http://mirrors.aliyun.com/ubuntu/ xenial-security universe
deb http://mirrors.aliyun.com/ubuntu/ xenial-security multiverse
```

然后执行：

```
sudo apt update
```

更新源。

但其实阿里云服务器的Ubuntu系统本身已经帮你修改好了apt的源，所以你在使用阿里云服务器的Ubuntu系统时并不需要执行上面的操作，你只需要在使用apt 安装一些软件之前执行：`sudo apt update`就好了。

## 安装Vim
你可以使用：

```
sudo apt install vim
```
安装vim ，当然由于你现在可能是root用户，所以你不需要加sudo 直接输入：

```
apt install vim
```
就可以安装。但是更好的是阿里云服务器其实已经帮你安装了vim，所以你根本不需要在安装。你可以在终端输入：

```
vim
```
他会显示如下的信息给你，说明你已经安装了vim
![QQ20181106-215200@2x](http://pc59bkg3l.bkt.clouddn.com/QQ20181106-215200@2x.png)


## 安装mysql 数据库
使用如下命令安装mysql数据库：

```
sudo apt install mysql-server mysql-client
```
在安装的时候会让你设定数据库的密码，输入自己想设定的数据库密码即可。

安装完成后可以使用：

```
mysql --help
```
查看是否安装成功，更确定的是我们可以尝试使用一下mysql,输入：

```
mysql -uroot -p
```
会提示你输入数据库的密码（就是你在安装数据的时候设定的）
你也可以尝试查看一些数据库：
![QQ20181106-215848@2x](http://pc59bkg3l.bkt.clouddn.com/QQ20181106-215848@2x.png)

```
mysql> show database;
```
![QQ20181106-220031@2x](http://pc59bkg3l.bkt.clouddn.com/QQ20181106-220031@2x.png)


注意别忘了最后的分号。最后输入`quit;`退出mysql。

## 安装memcached：
通过命令：

```
apt install memcached
```
即可安装。
然后测试一下:

```
telnet 127.0.0.1 11211
```
再尝试存储一下数据：

```
set username 0 60 5
hello
```

然后在获取一下数据：

```
get username
```
![QQ20181106-220455@2x](http://pc59bkg3l.bkt.clouddn.com/QQ20181106-220455@2x.png)

发现可以操作时说明没问题。(输入quit退出memcached)

## 安装python3
Ubuntu系统会自己默认给我们安装python2.7，你可以使用`python -V`查看当前的python 版本。但是由于我们使用的是python3所以还需要安装python3:

```
sudo apt install python3
```
安装完成后可以使用：

```
python3 -V
```
查看一下

安装完python3之后还需要安装python3对应的pip(pip不懂的话请请自行谷歌)

```
sudo apt install python3-pip
```
这里会安装python3对应使用的pip3
>pip 是用来管理python的包的工具，直接输入python默认代表的python2，对应的pip是pip2，所以输入时python、pip代表的分别是python2和pip2。而如果想使用python3版本就需要输入：python3和pip3。这里的系统默认安装的是python2 和pip2但是我们需要python3和pip3,所以需要重新安装。

安装完pip3之后可以查看一下pip的版本：

![QQ20181106-221952@2x](http://pc59bkg3l.bkt.clouddn.com/QQ20181106-221952@2x.png)

可以看到pip和pip3的版本都是8.1,但是我们需要使用最新的pip3的包，所以需要更新pip3（由于pip2我们不使用所以就不更新了）

```
pip3 install --upgrade pip
```
但是会报如下错误：
![QQ20181106-223005@2x](http://pc59bkg3l.bkt.clouddn.com/QQ20181106-223005@2x.png)

这主要是因为pip3新旧版本的问题。

我们尝试修改一下`/usr/bin/pip3`中的内容就。
打开`/usr/bin/pip3`


```
vim /usr/bin/pip3
```
内容如下:

```
#!/usr/bin/python3
# GENERATED BY DEBIAN

import sys

# Run the main entry point, similarly to how setuptools does it, but because
# we didn't install the actual entry point from setup.py, don't use the
# pkg_resources API.
from pip import main
if __name__ == '__main__':
    sys.exit(main())
~
~
```
修改为：

```
from pip import __main__
 if __name__ == '__main__':
     sys.exit(__main__._main())

```
如果还报错，直接重新强制升级安装：

```
sudo python3 -m pip install --upgrade --force-reinstall pip

```
重新查看一下：

```
pip3 --version

```

![QQ20181106-230237@2x](http://pc59bkg3l.bkt.clouddn.com/QQ20181106-230237@2x.png)

更新到了18.1

## 安装virtualenvwrapper，

```
 pip3 install virtualenvwrapper

```
安装完成之后我们还需要做一些配置：
1.在用户目录下（cd ~/）新建一个文件夹“.vitualenvs”用来存放我们的虚拟环境

```
cd ~/
mkdir .virtualenvs
```
然后执行`ls -al`看一下：

![QQ20181107-000835@2x](http://pc59bkg3l.bkt.clouddn.com/QQ20181107-000835@2x.png)
发现 .virtualenvs 文件夹

2.配置环境变量
我们安装完成之后还无法使用virtualenvwrapper命令，还需要配置环境变量。
先执行：

```
which virtualenvwrapper.sh
```
看一下我们的virtualenvwrapper路径
![QQ20181107-001206@2x](http://pc59bkg3l.bkt.clouddn.com/QQ20181107-001206@2x.png)

在：

```
/usr/local/bin/virtualenvwrapper.sh
```
路径下。

然后 打开用户目录下的 .bashrc文件
在最后添加下面代码:

```
export WORKON_HOME=$HOME/.virtualenvs
  source /usr/local/bin/virtualenvwrapper.sh
```
然后退出.bashrc文件，输入命令`source ~/.bashrc`使.bashrc生效。



接下来我们就可以使用命令来创建虚拟环境变量了：（由于我们的virtualenvwrapper安装在了pyton3环境中所以可以直接创建）

```
mkvirtualenv xfz-env
```

注意：如果你把virtualenvwrapper安装在了python2的环境中，在创建虚拟环境的时候需要使用--python参数指定使用哪个Python文件，安装python3的路径是在/usr/bin/python3。那么示例代码如下：

```
mkvirtualenv --python=/usr/bin/python3 xfz-env
```
创建完成可以在“。virtualenvs”目录下查看env环境：
![QQ20181107-002144@2x](http://pc59bkg3l.bkt.clouddn.com/QQ20181107-002144@2x.png)

你可以使用：

```
workon xfz-env
```
进入到指定的虚拟环境

注意在source .bashrc如果出现以下错误:

```
No module named virtualenvwrapper
virtualenvwrapper.sh: There was a problem running the initialization hooks.

If Python could not import the module virtualenvwrapper.hook_loader,
check that virtualenvwrapper has been installed for
VIRTUALENVWRAPPER_PYTHON=/usr/bin/python and that PATH is
set properly.
```
那么在 .bashrc 加入:

```
 export VIRTUALENVWRAPPER_PYTHON=/usr/bin/python3
```

## 从远程仓库下载代码
我们应该应该吧完整的代码上传到了自己的GitHub或者码云中，接下来我们需要从远程仓库把代码pull到服务器：

1.首先进入到 "/src"，`cd /src`
2.在/src下新建一个项目文件夹，比如我的是  

```
mkdir xiaofaozhuo
```
3.然后进入xiaofaozhuo文件夹执行：

```
git init
git remote add origin https://gitee.com/PuGuoJing/xiaofanzhuo
git pull origin master
```
如果没有安装git 执行：

```
apt install git
```

安装git。

这样你就可以把所有的远程代码下载到服务器了。

### 安装require.txt依赖包

进入自己的虚拟环境中，然后进入到项目所在的目录，执行命令：

```
pip3 install -r requirements.txt
```
安装项目依赖的包。如果提示OSError: mysql_config not found，那么再安装:

```
sudo apt install libmysqld-dev
```


即可。

注意短信验证码的包需要单独安装。把dysms_python文件夹上传到项目中，然后进入到这个文件夹中。执行命令：python setup.py install。

> 对于一些第三方的无法通过pip安装的包，这里我们需要手动安装，比如这里的阿里云短信验证码服务就需要通过setup.py手动安装。

### 创建数据库
在安装好所有的环境之后，我们需要创建我们项目使用的数据库。
 
 首先进入我们的数据：
```
mysql -uroot -p
```
然后执行：

```
create database  xfz;
```
创建我们所使用的数据xfz。
创建完成后我们可以使用：

```
show databases;
```
![QQ20181118-232002@2x](http://pc59bkg3l.bkt.clouddn.com/QQ20181118-232002@2x.png)

查看数据库。
之后我们进入到项目根路径执行:

```
python3 manage.py makemigrations
python3 manage.py migrate
```
将模型映射到数据库中，这样我们的数据库创建成功，可以使用了。

在数据库创建成功之后其实我们往往还需要一个需求，就是我们想可以在远程使用navcat去连接查看我们的数据库，那接下来我们还需要做下面几件事。

1.开启阿里云网络安全组中的3306端口的防火墙。
![QQ20181118-232930@2x](http://pc59bkg3l.bkt.clouddn.com/QQ20181118-232930@2x.png)
具体如何开启请开我的另一篇博客[Mac下购买配置和访问阿里云服务器的详细步骤](http://www.puguojing.com/2018/11/06/Mac%E4%B8%8B%E8%B4%AD%E4%B9%B0%E9%85%8D%E7%BD%AE%E5%92%8C%E8%AE%BF%E9%97%AE%E9%98%BF%E9%87%8C%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4/)中的**[MAC使用ssh远程连接阿里云服务器]****[添加网络安全组]** 或者自行百度。

2.为我们的数据库创建用户授权，这样才可以远程连接。
具体参考：[阿里云远程连接数据库](https://www.aliyun.com/ss/6L-c56iL6L-e5o6lbXlzcWzmlbDmja7lupM/a)

3.修改我们的数据库中的配置文件ALLOW_HOST,如果该配置为127.0.0.1，请删除或注释掉此行。

注意windows下mysql配置文件是.ini文件，linux下是.cnf文件，请找到自己对应的配置文件修改。

linux 一般在/etc/mysql/下有mysqld.cnf
但是博主的是在：

```
/etc/mysql/mysql.conf.d/mysqld.cnf
```

下所以根据自己的情况查找。

在配置好上述之后一般就可以通过navcat远程连接我们的数据库了。用户名和密码就是你在第二部开启权限的用户名密码。

### 测试运行项目
首先我们需要修改setting.py中的ALLOW_HOST=[47.92.52.97]，即我们阿里云服务器的公网Ip这样就可以通过其他电脑访问我们的服务器了。

然后我们在项目下执行:

```
python3 manage.py runserver 0.0.0.0:8000
```
这样就可以通过Ip:8000 来访问我们的网站了，在网站地址栏输入：
http://47.92.53.97：8000
就可以看到我们的网站了，但是这个时候可能会有一些显示问题，这主要是我们的静态文件未正确加载。

### 收集静态文件（css\js\image）
项目中我们的静态文件一般都是分散的。不方便服务器处理，所以我们需要把所有的静态文件收集到一个文件夹中：

首先在我们在项目下新建议各位空文件夹:

```
mkdir static_dist 
```
用来存放素有的静态文件，然后在setting.py中配置:

```
STATIC_ROOT= os.path.join(BASE_DIR,'static_dist')
```

然后执行:

```
python manage.py collectstatic
```

collectstatic 会收集setting.py中的STATICFILES_DIRS 指定的目录所有的静态文件和各个app下的static下的静态文件到static_dist文件夹中。具体参考django文档。

![QQ20181119-000117@2x](http://pc59bkg3l.bkt.clouddn.com/QQ20181119-000117@2x.png)

### 安装配置uwsgi
uwsgi是一个应用服务器，非静态文件的网络请求就必须通过他完成，他也可以充当静态文件服务器，但不是他的强项。uwsgi是使用python编写的，因此通过pip3 install uwsgi就可以了。(uwsgi必须安装在系统级别的Python环境中，不要安装到虚拟环境中)。然后创建一个叫做uwsgi.ini的配置文件（原则上可以在任何位置创建，这里我们可以在项目目录里创建）：


```
[uwsgi]

# 必须全部为绝对路径
# 项目的路径
chdir           = /srv/xiaofanzhuan  #表示我们项目在服务器中的绝对路径 
# Django的wsgi文件
module          = xiaofanzhuan.wsgi #指定我们项目中的wsgi文件
# Python虚拟环境的路径
home            = /root/.virtualenvs/xfz-env

# 进程相关的设置
# 主进程
master          = true
# 最大数量的工作进程
processes       = 10

http            = :8000  #运行端口

# 设置socket的权限
chmod-socket    = 666  #socket用用和nginx通信
# 退出的时候是否清理环境
vacuum          = true

daemonize       = /var/log/xfz_uwsgi.log  #指定log文件位置，一般的错误信息全在里面
```
然后通过命令uwsgi --ini uwsgi.ini运行，确保没有错误。然后在浏览器中访问http://ip地址:8000，如果能够访问到页面（可能没有静态文件）说明uwsgi配置没有问题。

通过ps aux | grep uwsgi 查看uwsgi运行情况，使用kill -9 第一个uwsgi pid  关闭uwsgi运行。

### 安装配置niginx
虽然uwsgi可以正常的部署我们的项目了。但我们还是依然要采用nginx来作为web服务器。使用nginx来作为web服务器有以下好处：

uwsgi对静态文件资源处理并不好，包括响应速度，缓存等。
nginx作为专业的web服务器，暴露在公网上会比uwsgi更加安全一点。
运维起来更加方便。比如要将某些IP写入黑名单，nginx可以非常方便的写进去。而uwsgi可能还要写一大段代码才能实现。

#### 安装：
通过apt install nginx即可安装。

####  nginx简单操作命令：
启动：service nginx start
关闭：service nginx stop
重启：service nginx restart
测试配置文件：service nginx configtest

添加配置文件：
在/etc/nginx/conf.d目录下，新建一个文件，叫做zhiliaoketang.conf，然后将以下代码粘贴进去：


```
upstream zhiliaoketang {
    server unix:///srv/zhiliaoketang/zhiliaoketang.sock; 
}

# 配置服务器
server {
    # 监听的端口号
    listen      80;
    # 域名
    server_name 192.168.0.101; 
    charset     utf-8;

    # 最大的文件上传尺寸
    client_max_body_size 75M;  

    # 静态文件访问的url
    location /static {
        # 静态文件地址
        alias /srv/zhiliaoketang/static_dist; 
    }

    # 最后，发送所有非静态文件请求到django服务器
    location / {
        uwsgi_pass  zhiliaoketang;
        # uwsgi_params文件地址
        include     /etc/nginx/uwsgi_params; 
    }
}
```

写完配置文件后，为了测试配置文件是否设置成功，运行命令：service nginx configtest，如果不报错，说明成功。
每次修改完了配置文件，都要记得运行service nginx restart。
### uwsgi 和nginx的关系及他们各自的作用。



### 使用supervisor管理uwsgi进程：
让supervisor管理uwsgi，可以在uwsgi发生意外的情况下，会自动的重启。

#### 安装supervisor：
因为supervisor是用python写成的，所以通过pip即可安装。
并且因为supervisor不支持python3，因此需要把supervisor安装在python2的环境中。
pip2 install supervisor。

#### 启动：
在项目的根目录下创建一个文件叫做supervisor.conf，然后将以下代码填入到配置文件中：

```
 # supervisor的程序名字
    [program:mysite]
    # supervisor执行的命令
    command=uwsgi --ini zlkt_uwsgi.ini
    # 项目的目录
    directory = /srv/zhiliaoketang 
    # 开始的时候等待多少秒
    startsecs=0
    # 停止的时候等待多少秒
    stopwaitsecs=0  
    # 自动开始
    autostart=true
    # 程序挂了后自动重启
    autorestart=true
    # 输出的log文件
    stdout_logfile=/srv/zhiliaoketang/log/supervisord.log
    # 输出的错误文件
    stderr_logfile=/srv/zhiliaoketang/log/supervisord.err

    [supervisord]
    # log的级别
    loglevel=debug

    [inet_http_server]
    # supervisor的服务器
    port = :9001
    # 用户名和密码
    username = admin
    password = 123

    # 使用supervisorctl的配置
    [supervisorctl]
    # 使用supervisorctl登录的地址和端口号
    serverurl = http://127.0.0.1:9001

    # 登录supervisorctl的用户名和密码
    username = admin
    password = 123

    [rpcinterface:supervisor]
    supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface
```

然后使用命令supervisord -c supervisor.conf运行就可以了。
以后如果想要启动uwsgi，就可以通过命令supervisorctl -c supervisor.conf进入到管理控制台，然后可以执行相关的命令进行管理：

status # 查看状态
start program_name #启动程序
restart program_name #重新启动程序
stop program_name # 关闭程序
reload # 重新加载配置文件
quit # 退出控制台


